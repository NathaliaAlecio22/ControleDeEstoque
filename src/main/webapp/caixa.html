<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Caixa - Quitanda</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            gap: 20px;
        }
        .section {
            flex: 1;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        .produto-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .produto-item:hover {
            background-color: #f9f9f9;
        }
        .carrinho table {
            width: 100%;
            border-collapse: collapse;
        }
        .carrinho th, .carrinho td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .carrinho th {
            background-color: #f2f2f2;
        }
        #valor-pago-container {
            margin-top: 20px;
            text-align: right;
        }
        #btn-finalizar {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="section">
        <h2>Produtos Disponíveis</h2>
        <div id="lista-produtos">
            </div>
    </div>

    <div class="section carrinho">
        <h2>Carrinho de Compras</h2>
        <table>
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Qtd</th>
                    <th>Preço Unit.</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="carrinho-tabela-body">
                </tbody>
        </table>

        <div id="valor-pago-container">
            <h3>Total: R$ <span id="valor-total">0.00</span></h3>
            <label for="valor-pago">Valor Pago:</label>
            <input type="number" id="valor-pago" step="0.01" required>
            <button id="btn-finalizar">Finalizar Venda</button>
        </div>
    </div>

    <script>
        const produtosApiUrl = 'http://localhost:8080/QuitandaBackend/produtos';
        const vendasApiUrl = 'http://localhost:8080/QuitandaBackend/vendas';
        const listaProdutosDiv = document.getElementById('lista-produtos');
        const carrinhoTabelaBody = document.getElementById('carrinho-tabela-body');
        const valorTotalSpan = document.getElementById('valor-total');
        const btnFinalizar = document.getElementById('btn-finalizar');
        const valorPagoInput = document.getElementById('valor-pago');

        let carrinho = {}; // Objeto para armazenar os itens do carrinho {produtoId: {produto, quantidade}}

        // Função para carregar os produtos disponíveis
        function carregarProdutos() {
            fetch(produtosApiUrl)
                .then(response => response.json())
                .then(produtos => {
                    listaProdutosDiv.innerHTML = '';
                    produtos.forEach(produto => {
                        const produtoItem = document.createElement('div');
                        produtoItem.className = 'produto-item';
                        produtoItem.innerHTML = `<span>${produto.nome} (R$ ${produto.precoVenda.toFixed(2)})</span>`;
                        produtoItem.addEventListener('click', () => adicionarAoCarrinho(produto));
                        listaProdutosDiv.appendChild(produtoItem);
                    });
                });
        }

        // Função para adicionar um produto ao carrinho
        function adicionarAoCarrinho(produto) {
            const produtoId = produto.id;
            if (carrinho[produtoId]) {
                carrinho[produtoId].quantidade++;
            } else {
                carrinho[produtoId] = {
                    produto: produto,
                    quantidade: 1
                };
            }
            atualizarCarrinho();
        }

        // Função para atualizar a exibição do carrinho
        function atualizarCarrinho() {
            carrinhoTabelaBody.innerHTML = '';
            let total = 0;
            for (const produtoId in carrinho) {
                const item = carrinho[produtoId];
                const subtotal = item.produto.precoVenda * item.quantidade;
                total += subtotal;

                const row = carrinhoTabelaBody.insertRow();
                row.insertCell(0).textContent = item.produto.nome;
                row.insertCell(1).textContent = item.quantidade;
                row.insertCell(2).textContent = `R$ ${item.produto.precoVenda.toFixed(2)}`;
                row.insertCell(3).textContent = `R$ ${subtotal.toFixed(2)}`;
            }
            valorTotalSpan.textContent = total.toFixed(2);
        }

        // Lógica para finalizar a venda
        btnFinalizar.addEventListener('click', () => {
            const valorPago = parseFloat(valorPagoInput.value);
            const valorTotal = parseFloat(valorTotalSpan.textContent);

            if (valorPago < valorTotal) {
                alert('Valor pago é insuficiente!');
                return;
            }

            const itensParaVenda = [];
            for (const produtoId in carrinho) {
                const item = carrinho[produtoId];
                itensParaVenda.push({
                    produtoId: item.produto.id,
                    quantidade: item.quantidade
                });
            }

            // Envia a requisição POST para a API de vendas
            fetch(`${vendasApiUrl}?valorPago=${valorPago}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(itensParaVenda)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message) });
                }
                return response.json();
            })
            .then(data => {
                alert(`Venda finalizada com sucesso! Troco: R$ ${(valorPago - valorTotal).toFixed(2)}`);
                carrinho = {}; // Limpa o carrinho
                valorPagoInput.value = '';
                atualizarCarrinho();
                carregarProdutos(); // Atualiza a lista de produtos (estoque)
            })
            .catch(error => {
                alert('Falha ao registrar a venda: ' + error.message);
            });
        });

        // Chama a função para carregar os produtos quando a página é carregada
        document.addEventListener('DOMContentLoaded', carregarProdutos);
    </script>
</body>
</html>